<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliver-epper.de/posts/create-a-document-based-editor-with-xib-files-and-swifty-cocoa-bindings"/><meta name="twitter:url" content="https://oliver-epper.de/posts/create-a-document-based-editor-with-xib-files-and-swifty-cocoa-bindings"/><meta name="og:url" content="https://oliver-epper.de/posts/create-a-document-based-editor-with-xib-files-and-swifty-cocoa-bindings"/><title>Create a document based editor with xib files and swifty cocoa bindings | oliep</title><meta name="twitter:title" content="Create a document based editor with xib files and swifty cocoa bindings | oliep"/><meta name="og:title" content="Create a document based editor with xib files and swifty cocoa bindings | oliep"/><meta name="description" content="How to create document based editor with xib files and Cocoa Bindings"/><meta name="twitter:description" content="How to create document based editor with xib files and Cocoa Bindings"/><meta name="og:description" content="How to create document based editor with xib files and Cocoa Bindings"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">My posts</a></li><li><a href="https://golf.oliver-epper.de">Golf</a></li><li><a href="/bikerr">Bikerr</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>Create a document based editor with xib files and swifty cocoa bindings</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>16. November 2020</li><li><span class="fas fa-clock"></span>4-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/macos">macOS</a>&middot;<a href="/tags/appkit">AppKit</a>&middot;<a href="/tags/keypath">KeyPath</a>&middot;<a href="/tags/cocoabindings">CocoaBindings</a></div></div><p>While learning how to write really good Mac Apps I figured that I simply cannot rely on SwiftUI alone, just yet. SwiftUI is really cool but AppKit has so much to offer and SwiftUI still lacks a few bits and pieces on the Mac. If you're interested in building a document based app in SwiftUI, Gui Rambo has a nice article <a href="https://wwdcbysundell.com/2020/creating-document-based-apps-in-swiftui/">Creating document-based apps using SwiftUI</a>.</p><h2>Create the App</h2><p>While I do like to use Interface Builder sometimes I didn't want to use Storyboards, here. So let's start by creating a "Document App" and choose XIB for the interface type. If you run the app you should see something like this:</p><figure>
    <picture>
        <source srcset="/images/AppWindow-dark.png" media="(prefers-color-scheme: dark)">
        <img src="/images/AppWindow.png" alt="AppWindow">
    </picture>
</figure><p>We want do do things a little bit different so go ahead an delete Document.xib. Let's create two Controllers. One NSWindowController and one NSViewController that we will use to present the NSTextView.</p><h3>Create the WindowController</h3><p>So press CMD-N choose <strong>Cocoa Class</strong> and name it <code>DocumentWindowController</code>. Make it a subclass of <code>NSWindowController</code> and check <strong>Also create XIB file</strong>.</p><figure>
    <picture>
        <source srcset="/images/Create_DocumentWindowController-dark.png" media="(prefers-color-scheme: dark)">
        <img src="/images/Create_DocumentWindowController.png" alt="Create DocumentWindowController">
    </picture>
</figure><p>Rename the DocumentWindowController.xib to Document.xib.</p><h3>Create the ViewController</h3><p>Press CMD-N choose <strong>Cocoa Class</strong> and name it <code>EditorViewController</code>. Make it a subclass of <code>NSViewController</code> and check <strong>Also create XIB file</strong>.</p><figure>
    <picture>
        <source srcset="/images/Create_EditorViewController-dark.png" media="(prefers-color-scheme: dark)">
        <img src="/images/Create_EditorViewController.png" alt="Create EditorViewController">
    </picture>
</figure><h3>Create the model</h3><p>Create a new file Content.swift with the following content:</p><pre><code><div class="highlight"><span></span><span class="kd">import</span> <span class="nc">Foundation</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Content</span><span class="p">:</span> <span class="bp">NSObject</span> <span class="p">{</span>
    <span class="kr">@objc</span> <span class="kr">dynamic</span> <span class="kd">var</span> <span class="nv">contentString</span><span class="p">:</span> <span class="nb">String</span>

    <span class="kd">public</span> <span class="kd">init</span><span class="p">(</span><span class="n">contentString</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">contentString</span> <span class="p">=</span> <span class="n">contentString</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="nc">Content</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">read</span><span class="p">(</span><span class="n">from</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">contentString</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span> <span class="p">??</span> <span class="s">&quot;&quot;</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">data</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Data</span><span class="p">?</span> <span class="p">{</span>
        <span class="n">contentString</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>Since we want to use Cocoa Bindings the <code>contentString</code> variable needs to be accessible from the Objective-C runtime. <code>@objc</code> makes the var available to Objective-C and <code>dynamic</code> chooses dynamic dispatch instead of static dispatch.</p><h3>Edit the Document class</h3><p>Every Document needs its own NSWindowController. Remember how we deleted the original Document.xib that came with the template? Since we renamed the xib that came with our DocumentWindowController to Document.xib we can still start the app. But our DocumentWindowController will not be loaded.</p><p>To prove: Set a breakpoint to <code>windowDidLoad</code> in DocumentWindowController.</p><p>So although the "File's Owner" propety of our renamed Document.xib still points to our controller, that does not mean that the controller gets loaded. That's not how this works. Even if you would rename the xib back to its original name and change the var <code>windowNibName</code> in <code>Document</code> to return the right name the breakpoint would still not be hit.</p><p>Let's change that: First delete the override of the var <code>windowNibName</code> from the <code>Document</code>. Now let's override the function <code>makeWindowControllers</code>:</p><pre><code><div class="highlight"><span></span><span class="kr">override</span> <span class="kd">func</span> <span class="nf">makeWindowControllers</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">windowController</span> <span class="p">=</span> <span class="n">DocumentWindowController</span><span class="p">(</span><span class="n">windowNibName</span><span class="p">:</span> <span class="s">&quot;Document&quot;</span><span class="p">)</span>
    <span class="n">addWindowController</span><span class="p">(</span><span class="n">windowController</span><span class="p">)</span>
<span class="p">}</span>
</div></code></pre><p>If you build and run again you will now hit the breakpoint.</p><h4>Hook up the EditorViewController</h4><p>Add another line to the funtion <code>makeWindowControllers</code>:</p><pre><code><div class="highlight"><span></span><span class="n">windowController</span><span class="p">.</span><span class="n">contentViewController</span> <span class="p">=</span> <span class="n">EditorViewController</span><span class="p">()</span>
</div></code></pre><p>You don't need to specify the nibName here, if it equals the NSViewControllers name. Want proove again? Drop a "Hello World" label in the EditorViewController.xib and restart the app. ðŸ˜€</p><p>Before we continue to create the UI let's finish the work on the Document class.</p><p>Add a memeber that will hold the model:</p><pre><code><div class="highlight"><span></span><span class="kr">@objc</span> <span class="kd">var</span> <span class="nv">content</span> <span class="p">=</span> <span class="n">Content</span><span class="p">(</span><span class="n">contentString</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</div></code></pre><p>Set the model as the ViewControllers representedObject. So change <code>makeWindowControllers</code> to this:</p><pre><code><div class="highlight"><span></span><span class="kr">override</span> <span class="kd">func</span> <span class="nf">makeWindowControllers</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">windowController</span> <span class="p">=</span> <span class="n">DocumentWindowController</span><span class="p">(</span><span class="n">windowNibName</span><span class="p">:</span> <span class="s">&quot;Document&quot;</span><span class="p">)</span>
    <span class="n">addWindowController</span><span class="p">(</span><span class="n">windowController</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nv">editorViewController</span> <span class="p">=</span> <span class="n">EditorViewController</span><span class="p">()</span>
    <span class="n">editorViewController</span><span class="p">.</span><span class="n">representedObject</span> <span class="p">=</span> <span class="n">content</span>
    <span class="n">windowController</span><span class="p">.</span><span class="n">contentViewController</span> <span class="p">=</span> <span class="n">editorViewController</span>
<span class="p">}</span>
</div></code></pre><p>Last replace the body of the <code>data() -&gt; Data</code> function with</p><pre><code><div class="highlight"><span></span><span class="k">return</span> <span class="n">content</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="p">??</span> <span class="n">Data</span><span class="p">()</span>
</div></code></pre><p>and the body of the <code>read()</code> function with:</p><pre><code><div class="highlight"><span></span><span class="n">content</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
</div></code></pre><p>That's it for the <code>Document</code> class.</p><h2>Wire up the EditorViewController</h2><p>Delete the label (if you added it) from the nib and replace it with a NSTextView that you constrain to all for edges. In the Bindings Inspector select value and bind it to: "File's Owner" use <code>self.representedObject.contentString</code> as the "Model Key Path" and check "Continuously Update value". If you want you can add a <code>didSet</code> to the contentString var in <code>Content</code> to see it updates like this:</p><pre><code><div class="highlight"><span></span><span class="kr">@objc</span> <span class="kr">dynamic</span> <span class="kd">var</span> <span class="nv">contentString</span><span class="p">:</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="kr">didSet</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="n">contentString</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>If you build and run now you'll see what you enter in the TextView beeing printed to the console.</p><p>Let's try saving. Cool! What about opening a document? Restart the app and try opening the file. Works too. How neat :-D</p><h2>More Swifty Bindings</h2><p>Go ahead and delete the binding from the connections inspector. Thanks to Lucas Derraugh's fantastic youtube series about <a href="https://www.youtube.com/channel/UCDg-YmnNehm3KB0BpytkUJg">Apple Programming</a> I learned about a much nicer and swiftier way.</p><p>Create an outlet to the <code>NSTextView</code> in the <code>EditorViewController</code> and add the following line to <code>viewDidLoad()</code>:</p><pre><code><div class="highlight"><span></span><span class="n">textView</span><span class="p">.</span><span class="n">bind</span><span class="p">(.</span><span class="n">value</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">representedObject</span><span class="p">!,</span> <span class="n">withKeyPath</span><span class="p">:</span> <span class="s">&quot;contentString&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="p">[</span><span class="n">NSBindingOption</span><span class="p">.</span><span class="n">continuouslyUpdatesValue</span><span class="p">:</span> <span class="kc">true</span><span class="p">])</span>
</div></code></pre><p>We're immediately back in business. Value is still bound to <code>contentString</code> and through the options dictionary we still tell the <code>NSTextView</code> to send updates continuously. But Lucas had another cool idea:</p><p>Create the following extentions on <code>NSObject</code>:</p><pre><code><div class="highlight"><span></span><span class="kd">extension</span> <span class="bp">NSObject</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">bind</span><span class="p">&lt;</span><span class="n">Root</span><span class="p">,</span> <span class="n">Value</span><span class="p">&gt;(</span><span class="kc">_</span> <span class="n">binding</span><span class="p">:</span> <span class="n">NSBindingName</span><span class="p">,</span> <span class="n">to</span> <span class="n">observable</span><span class="p">:</span> <span class="n">Root</span><span class="p">,</span> <span class="n">keyPath</span><span class="p">:</span> <span class="n">KeyPath</span><span class="p">&lt;</span><span class="n">Root</span><span class="p">,</span> <span class="n">Value</span><span class="p">&gt;,</span> <span class="n">options</span><span class="p">:</span> <span class="p">[</span><span class="n">NSBindingOption</span><span class="p">:</span> <span class="nb">Any</span><span class="p">]?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">kvcKeyPath</span> <span class="p">=</span> <span class="n">keyPath</span><span class="p">.</span><span class="n">_kvcKeyPathString</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;KeyPath does not contain @objc exposed values&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">bind</span><span class="p">(</span><span class="n">binding</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">observable</span><span class="p">,</span> <span class="n">withKeyPath</span><span class="p">:</span> <span class="n">kvcKeyPath</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">options</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>With that in place we can get rid of the <em>stringly</em> typed keyPath on the call side and use a Swift KeyPath:</p><pre><code><div class="highlight"><span></span> <span class="k">if</span> <span class="kd">let</span> <span class="nv">content</span> <span class="p">=</span> <span class="n">representedObject</span> <span class="k">as</span><span class="p">?</span> <span class="n">Content</span> <span class="p">{</span>
            <span class="n">textView</span><span class="p">.</span><span class="n">bind</span><span class="p">(.</span><span class="n">value</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">content</span><span class="p">,</span> <span class="n">keyPath</span><span class="p">:</span> <span class="err">\</span><span class="p">.</span><span class="n">contentString</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="p">[</span><span class="n">NSBindingOption</span><span class="p">.</span><span class="n">continuouslyUpdatesValue</span><span class="p">:</span> <span class="kc">true</span><span class="p">])</span>
        <span class="p">}</span>
</div></code></pre><p>That's much better ðŸ’ª</p><p>Are you interested in doing the above completely in code? Or use Combine to bind to the model? Let's chat.</p></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>