<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliver-epper.de/posts/wrap-nstextview-in-swiftui"/><meta name="twitter:url" content="https://oliver-epper.de/posts/wrap-nstextview-in-swiftui"/><meta name="og:url" content="https://oliver-epper.de/posts/wrap-nstextview-in-swiftui"/><title>Wrap NSTextView in SwiftUI | oliep</title><meta name="twitter:title" content="Wrap NSTextView in SwiftUI | oliep"/><meta name="og:title" content="Wrap NSTextView in SwiftUI | oliep"/><meta name="description" content="How to wrap a NSTextView in SwiftUI"/><meta name="twitter:description" content="How to wrap a NSTextView in SwiftUI"/><meta name="og:description" content="How to wrap a NSTextView in SwiftUI"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">My posts</a></li><li><a href="https://golf.oliver-epper.de">Golf</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>Wrap NSTextView in SwiftUI</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>7. Dezember 2020</li><li><span class="fas fa-clock"></span>3-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/macos">macOS</a>&middot;<a href="/tags/appkit">AppKit</a>&middot;<a href="/tags/nstextview">NSTextView</a>&middot;<a href="/tags/swiftui">SwiftUI</a></div></div><p>During WWDC 2020 SwiftUI lerned a few new things. For example Map and TextEditor. Both are neat additions but still not capable of replacing their corresponding AppKit or UIKit counterparts. The SwiftUI Map can handle annotations but not overlays, yet. And the TextEditor cannot present NSAttributedStrings. So let's wrap a NSTextView in SwiftUI and handle the updating of the model data in an efficient way.</p><h2>Create a ViewController that presents the NSTextView</h2><p>This is pretty easy and no different than you'd expect:</p><pre><code><div class="highlight"><span></span><span class="kd">class</span> <span class="nc">EditorController</span><span class="p">:</span> <span class="n">NSViewController</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">textView</span> <span class="p">=</span> <span class="n">NSTextView</span><span class="p">()</span>
    
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">loadView</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">scrollView</span> <span class="p">=</span> <span class="n">NSScrollView</span><span class="p">()</span>
        <span class="n">scrollView</span><span class="p">.</span><span class="n">hasVerticalScroller</span> <span class="p">=</span> <span class="kc">true</span>
        
        <span class="n">textView</span><span class="p">.</span><span class="n">autoresizingMask</span> <span class="p">=</span> <span class="p">[.</span><span class="n">width</span><span class="p">]</span>
        <span class="n">textView</span><span class="p">.</span><span class="n">allowsUndo</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="n">textView</span><span class="p">.</span><span class="n">font</span> <span class="p">=</span> <span class="p">.</span><span class="n">systemFont</span><span class="p">(</span><span class="n">ofSize</span><span class="p">:</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">scrollView</span><span class="p">.</span><span class="n">documentView</span> <span class="p">=</span> <span class="n">textView</span>
        
        <span class="kc">self</span><span class="p">.</span><span class="n">view</span> <span class="p">=</span> <span class="n">scrollView</span>
    <span class="p">}</span>
    
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidAppear</span><span class="p">()</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">window</span><span class="p">?.</span><span class="n">makeFirstResponder</span><span class="p">(</span><span class="kc">self</span><span class="p">.</span><span class="n">view</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>In <code>viewDidAppear()</code> I make the controllers view the first responder. I like to be able to start typing immmediatly when the view get's presented and not have to click with the mouse, first. 😎</p><h2>Create a Representable</h2><p>To wrap a <code>NSViewController</code> inside a SwiftUI View struct you can use the protocol <code>NSViewControllerRepresentable</code>:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">EditorControllerView</span><span class="p">:</span> <span class="n">NSViewControllerRepresentable</span> <span class="p">{</span>
    <span class="p">@</span><span class="n">Binding</span> <span class="kd">var</span> <span class="nv">text</span><span class="p">:</span> <span class="nb">String</span>
    
    <span class="kd">func</span> <span class="nf">makeCoordinator</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Coordinator</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">Coordinator</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">class</span> <span class="nc">Coordinator</span><span class="p">:</span> <span class="bp">NSObject</span><span class="p">,</span> <span class="bp">NSTextStorageDelegate</span> <span class="p">{</span>
        <span class="kd">private</span> <span class="kd">var</span> <span class="nv">parent</span><span class="p">:</span> <span class="n">EditorControllerView</span>
        <span class="kd">var</span> <span class="nv">shouldUpdateText</span> <span class="p">=</span> <span class="kc">true</span>
        
        <span class="kd">init</span><span class="p">(</span><span class="kc">_</span> <span class="n">parent</span><span class="p">:</span> <span class="n">EditorControllerView</span><span class="p">)</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">parent</span> <span class="p">=</span> <span class="n">parent</span>
        <span class="p">}</span>
        
        <span class="kd">func</span> <span class="nf">textStorage</span><span class="p">(</span><span class="kc">_</span> <span class="n">textStorage</span><span class="p">:</span> <span class="bp">NSTextStorage</span><span class="p">,</span> <span class="n">didProcessEditing</span> <span class="n">editedMask</span><span class="p">:</span> <span class="n">NSTextStorageEditActions</span><span class="p">,</span> <span class="n">range</span> <span class="n">editedRange</span><span class="p">:</span> <span class="n">NSRange</span><span class="p">,</span> <span class="n">changeInLength</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="n">shouldUpdateText</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="kd">let</span> <span class="nv">edited</span> <span class="p">=</span> <span class="n">textStorage</span><span class="p">.</span><span class="n">attributedSubstring</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">editedRange</span><span class="p">).</span><span class="n">string</span>
            <span class="kd">let</span> <span class="nv">insertIndex</span> <span class="p">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">utf16</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">utf16</span><span class="p">.</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">offsetBy</span><span class="p">:</span> <span class="n">editedRange</span><span class="p">.</span><span class="n">lowerBound</span><span class="p">)</span>
            
            <span class="kd">func</span> <span class="nf">numberOfCharactersToDelete</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Int</span> <span class="p">{</span>
                <span class="n">editedRange</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">delta</span>
            <span class="p">}</span>
            
            <span class="kd">let</span> <span class="nv">endIndex</span> <span class="p">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">utf16</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">insertIndex</span><span class="p">,</span> <span class="n">offsetBy</span><span class="p">:</span> <span class="n">numberOfCharactersToDelete</span><span class="p">())</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">replaceSubrange</span><span class="p">(</span><span class="n">insertIndex</span><span class="p">..&lt;</span><span class="n">endIndex</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="n">edited</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">makeNSViewController</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EditorController</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">vc</span> <span class="p">=</span> <span class="n">EditorController</span><span class="p">()</span>
        <span class="n">vc</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">textStorage</span><span class="p">?.</span><span class="n">delegate</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">coordinator</span>
        <span class="k">return</span> <span class="n">vc</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">updateNSViewController</span><span class="p">(</span><span class="kc">_</span> <span class="n">nsViewController</span><span class="p">:</span> <span class="n">EditorController</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">text</span> <span class="o">!=</span> <span class="n">nsViewController</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">string</span> <span class="p">{</span>
            <span class="n">context</span><span class="p">.</span><span class="n">coordinator</span><span class="p">.</span><span class="n">shouldUpdateText</span> <span class="p">=</span> <span class="kc">false</span>
            <span class="n">nsViewController</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">string</span> <span class="p">=</span> <span class="n">text</span>
            <span class="n">context</span><span class="p">.</span><span class="n">coordinator</span><span class="p">.</span><span class="n">shouldUpdateText</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>The basic idea is to use a <code>NSTextStorageDelegate</code> to apply the edit that was done to the <code>textView.textStorage</code> to the <code>@Binding</code>-property.</p><p>But there's a bit to consider:</p><ul><li>Once the <code>@Binding</code> property got updated it will call the <code>updateNSViewController</code> function. This only needs to really do anything if the change originated from the SwiftUI-side of things. If the change came from the ViewController there is nothing more to do.</li></ul><ul><li>The internal representation of the string in the <code>NSTextStorage</code> is utf-16. So if you enter a 😎 in the <code>textView</code> the <code>textStorage</code>-delegate function will tell you that you edited from 0 to 2 and inserted 2 characters. If you replace the 😎 with a 👨‍👩‍👧‍👧 you will edit from 0 to 11 with a delta of 9. Easy 😬</li></ul><ul><li>So the function gets the string representing the editedRange from the <code>textStorage</code> and calculates the position to insert from the utf16-representation. If you replace the 👨‍👩‍👧‍👧 with a 😎 again you edited from 0 to 2 with a delta of -9. This means: for your one character long string to remain one character long you need to delete 9 characters from 2 to 11. ❤️</li></ul><p>Since every update has to change the <code>@Binding</code> property we do both in one go with the handy <code>replaceSubrange</code> function.</p><h2>Testdrive</h2><p>Yeah! Now we have a nice SwiftUI component:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">ContentView</span><span class="p">:</span> <span class="n">View</span> <span class="p">{</span>
    <span class="p">@</span><span class="n">State</span> <span class="kd">private</span> <span class="kd">var</span> <span class="nv">text</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
    
    <span class="kd">var</span> <span class="nv">body</span><span class="p">:</span> <span class="n">some</span> <span class="n">View</span> <span class="p">{</span>
        <span class="n">VStack</span><span class="p">(</span><span class="n">alignment</span><span class="p">:</span> <span class="p">.</span><span class="n">trailing</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">HStack</span> <span class="p">{</span>
                <span class="n">Text</span><span class="p">(</span><span class="s">&quot;count_key&quot;</span><span class="p">)</span>
                <span class="n">Text</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="bp">count</span><span class="p">))</span>
            <span class="p">}.</span><span class="n">padding</span><span class="p">()</span>
            <span class="n">EditorControllerView</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="err">$</span><span class="n">text</span><span class="p">)</span> <span class="c1">// our component</span>
            <span class="n">TextEditor</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="err">$</span><span class="n">text</span><span class="p">)</span> <span class="c1">// SwiftUI</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>Try editing in a long text &gt; 4Mb with and without the SwiftUI <code>TextEditor</code>.</p></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>