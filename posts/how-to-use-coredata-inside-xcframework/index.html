<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliverepper.github.io/posts/how-to-use-coredata-inside-xcframework"/><meta name="twitter:url" content="https://oliverepper.github.io/posts/how-to-use-coredata-inside-xcframework"/><meta name="og:url" content="https://oliverepper.github.io/posts/how-to-use-coredata-inside-xcframework"/><title>How to use CoreData inside xcframework | oliep</title><meta name="twitter:title" content="How to use CoreData inside xcframework | oliep"/><meta name="og:title" content="How to use CoreData inside xcframework | oliep"/><meta name="description" content="Use CoreData inside xcframework"/><meta name="twitter:description" content="Use CoreData inside xcframework"/><meta name="og:description" content="Use CoreData inside xcframework"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">My posts</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>How to use CoreData inside xcframework</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>20. Februar 2020</li><li><span class="fas fa-clock"></span>2-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/swift">Swift</a>&middot;<a href="/tags/ios">iOS</a>&middot;<a href="/tags/coredata">CoreData</a>&middot;<a href="/tags/xcframework">xcframework</a></div></div><p>The company I work for distributes a binary framework that records data on an iPhone. Since I am in charge of that framework and I enjoy working with CoreData I wanted to use it to store the collected data. Sadly my first attempt of doing this resulted in an error when I tried to use the framework inside an actual app.</p><blockquote><p>@NSManaged not allowed on computed properties</p></blockquote><p>This is coming from the generated .swiftinterface file so there is not much you can do about it. With a little research and some help I found the good news:</p><p>[[ModuleInterfaces] Don't diagnose @NSManaged properties with accessors #27676](https://github.com/apple/swift/pull/27676)</p><p>So there is a fix ðŸ¤—</p><h2>Get the fix</h2><p>At the time of writing all you need to do is to download and use the Xcode beta (11.4) which comes with a newer version of the Swift compiler that already has the fix. The rest is then pretty straight forward.</p><h2>Create the DataModel</h2><p>You can use File-&gt;New and then search for â€žData Modelâ€œ in the template chooser. I will call it `MyDataModel for demo purpose.</p><h2>Create an instance of NSPersistentContainer in your framework code</h2><p>This might not be obvious at first, but it is not hard. When you create an app with core data you get the following code inside your AppDelegate:</p><pre><code><div class="highlight"><span></span><span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">persistentContainer</span><span class="p">:</span> <span class="n">NSPersistentContainer</span> <span class="p">=</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span> <span class="n">NSPersistentContainer</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;DemoApp&quot;</span><span class="p">)</span>
  <span class="n">container</span><span class="p">.</span><span class="n">loadPersistentStores</span><span class="p">(</span><span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">storeDescription</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">error</span> <span class="p">=</span> <span class="n">error</span> <span class="k">as</span> <span class="bp">NSError</span><span class="p">?</span> <span class="p">{</span>
      <span class="bp">fatalError</span><span class="p">(</span><span class="s">&quot;Unresolved error </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">, </span><span class="si">\(</span><span class="n">error</span><span class="p">.</span><span class="n">userInfo</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="n">container</span>
<span class="p">}()</span>
</div></code></pre><p>While the initializer <code>init(name: String)</code> of <code>NSPersistentContainer</code> is pretty convenient we canâ€™t use it, because in the context of the running app it simply couldnâ€™t find the model. We need to use <code>init(name: String, managedObjectModel: NSManagedObjectModel)</code> to get the container. <code>NSManagedObjectModel</code> has an initializer that takes an <code>URL</code>.</p><p>So update the above to this instead:</p><pre><code><div class="highlight"><span></span><span class="kr">lazy</span> <span class="kd">var</span> <span class="nv">persistentContainer</span><span class="p">:</span> <span class="n">NSPersistentContainer</span> <span class="p">=</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">modelName</span> <span class="p">=</span> <span class="s">&quot;MyDataModel&quot;</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">modelDir</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">(</span><span class="k">for</span><span class="p">:</span> <span class="n">type</span><span class="p">(</span><span class="n">of</span><span class="p">:</span> <span class="kc">self</span><span class="p">)).</span><span class="n">url</span><span class="p">(</span><span class="n">forResource</span><span class="p">:</span> <span class="n">modelName</span><span class="p">,</span> <span class="n">withExtension</span><span class="p">:</span> <span class="s">&quot;momd&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="bp">fatalError</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">mom</span> <span class="p">=</span> <span class="bp">NSManagedObjectModel</span><span class="p">(</span><span class="n">contentsOf</span><span class="p">:</span> <span class="n">modelDir</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="bp">fatalError</span><span class="p">()</span> <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span> <span class="n">NSPersistentContainer</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">modelName</span><span class="p">,</span> <span class="n">managedObjectModel</span><span class="p">:</span> <span class="n">mom</span><span class="p">)</span>
    <span class="n">container</span><span class="p">.</span><span class="n">loadPersistentStores</span><span class="p">(</span><span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">storeDescription</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">error</span> <span class="p">=</span> <span class="n">error</span> <span class="k">as</span> <span class="bp">NSError</span><span class="p">?</span> <span class="p">{</span>
            <span class="bp">fatalError</span><span class="p">(</span><span class="s">&quot;Unresolved error </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">, </span><span class="si">\(</span><span class="n">error</span><span class="p">.</span><span class="n">userInfo</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">container</span>
<span class="p">}()</span>
</div></code></pre><h2>Final</h2><p>Please be aware, that a CoreData App has a <code>saveContext</code> function that gets automatically called by the <code>SceneDelegate</code> when the scene enters the background. If you want to use CoreData in a framework I guess youâ€™ll decide when to save by yourself, anyways.</p></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>