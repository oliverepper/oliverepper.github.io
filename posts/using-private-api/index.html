<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliver-epper.de/posts/using-private-api"/><meta name="twitter:url" content="https://oliver-epper.de/posts/using-private-api"/><meta name="og:url" content="https://oliver-epper.de/posts/using-private-api"/><title>Using private API | oliep</title><meta name="twitter:title" content="Using private API | oliep"/><meta name="og:title" content="Using private API | oliep"/><meta name="description" content="Find and use API that is private"/><meta name="twitter:description" content="Find and use API that is private"/><meta name="og:description" content="Find and use API that is private"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">Posts</a></li><li><a href="/apps">Apps</a></li><li><a href="https://golf.oliver-epper.de">Golf</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>Using private API</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>7. Oktober 2021</li><li><span class="fas fa-clock"></span>1-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/swift">Swift</a>&middot;<a href="/tags/hopper">Hopper</a></div></div><h2>The idea</h2><p>I needed a little tool that could show me which app has registered a certain URL on my Mac. Since the ouput of <code>lsregister -dump</code> is not quite eyecandy I decided to hack together a minimal tool that could do two things:</p><ul><li>show me a list of all registered URLs and their handlers</li><li>be able to unregister a handler</li></ul><p>Unfortunatley the public API of LaunchServices doesn't help with any of these.</p><h2>The resuce</h2><p>Well <code>lsregister</code> can unregister apps so it's time to drop it into <a href="https://www.hopperapp.com">Hopper</a> and start digging around. Often times this is way easier than you think. Drop lsregister into Hopper and search for unregister. You'll find a symbol <code>_LSUnregisterURL</code> immediately. If you don't have Hopper available you can use <code>nm lsregister | grep register</code>.</p><h2>The trick</h2><p><a href="https://www.helgehess.eu">Helge He√ü</a> pointed me to a nice way of making a private function available in Swift. Basically you can load a symbol with <code>dlsym</code> and then cast it to a type that has C calling convention.</p><pre><code><div class="highlight"><span></span><span class="kd">private</span> <span class="kd">let</span> <span class="nv">handle</span> <span class="p">=</span> <span class="n">dlopen</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">RTLD_NOW</span><span class="p">)</span>
<span class="kd">private</span> <span class="kd">let</span> <span class="nv">fnUnregister</span> <span class="p">=</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_LSUnregisterURL&quot;</span><span class="p">)</span>
<span class="kd">typealias</span> <span class="n">fnUnregisterType</span> <span class="p">=</span> <span class="p">@</span><span class="n">convention</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">(</span><span class="n">CFURL</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">OSStatus</span>

<span class="c1">// now you can cast</span>
<span class="kd">let</span> <span class="nv">LSUnregisterURL</span> <span class="p">=</span> <span class="bp">unsafeBitCast</span><span class="p">(</span><span class="n">fnUnregister</span><span class="p">,</span> <span class="n">to</span><span class="p">:</span> <span class="n">fnUnregisterType</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>

<span class="c1">// and call the function</span>
<span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">LSUnregisterURL</span><span class="p">(</span><span class="n">url</span> <span class="k">as</span> <span class="n">CFURL</span><span class="p">)</span>
</div></code></pre><h2>The constraints</h2><p>Actually you cannot run this function out of a sandbox. The obvious choice for such a tool would be to just disable the sandbox but hey: Why not wrap it in an XPCService?</p><h2>The tool</h2><p>If you want to check out the tool or find it useful yourself you can find it here: <a href="https://oliver-epper.de/apps/schemes/">Schemes</a>. Source available here: <a href="https://github.com/oliverepper/Schemes">Scheme Source</a>.</p></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>