<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliver-epper.de/posts/implementing-a-linux-syscall"/><meta name="twitter:url" content="https://oliver-epper.de/posts/implementing-a-linux-syscall"/><meta name="og:url" content="https://oliver-epper.de/posts/implementing-a-linux-syscall"/><title>Implementing a Linux syscall | oliep</title><meta name="twitter:title" content="Implementing a Linux syscall | oliep"/><meta name="og:title" content="Implementing a Linux syscall | oliep"/><meta name="description" content="Implement a syscall in the Linux kernel and call it from userspace"/><meta name="twitter:description" content="Implement a syscall in the Linux kernel and call it from userspace"/><meta name="og:description" content="Implement a syscall in the Linux kernel and call it from userspace"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">Posts</a></li><li><a href="/apps">Apps</a></li><li><a href="https://golf.oliver-epper.de">Golf</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>Implementing a Linux syscall</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>3. November 2021</li><li><span class="fas fa-clock"></span>3-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/linux">Linux</a>&middot;<a href="/tags/c">C</a></div></div><h2>Why</h2><p>Honestly, no good reason at all. I am neither a C programmer, nor a kernel hacker. But that said I am curious and this sounds like fun and I get to build a kernel again. Last time must have been version 2.something ;)</p><p><em>Spoiler</em>: Moores Law is not true. It took like 20 minutes to build a kernel 20 years ago, and it still takes 20 minutes ;)</p><h2>Disclaimer</h2><p>This is not my own work, I just searched a little bit on the internet. There is good documentation on <a href="https://www.kernel.org/doc/html/latest/process/adding-syscalls.html?highlight=syscall_define">kernel.org</a> and I got the idea from <a href="https://brennan.io/2016/11/14/kernel-dev-ep3/">Stephen Brennan</a>. I've just searched where to put the things for a linux version 5 arm build.</p><h2>Let's start</h2><p>First I'd recommend to setup a virtual Debian install. I know there are a bunch of nice distributions out there but I used Debian for a long time so that's what I prefer. Furthermore I need something with good aarch64 support since I'm going to play with this on a Mac.</p><p>I tried both Parallels and UTM and for this purpose both should work. You can install UTM via brew: <code>brew install utm</code>. Download a Debian installer and make the ISO available to the virtual machine. Please use more than 10GB for the virtual harddrive, you'll need it.</p><h2>Tools</h2><p>It is advisable to install the Parallels Tools for better performance if you go with Paralles. You can do that as root with</p><pre><code><div class="highlight"><span></span>mount /dev/cdrom /media/cdrom0
</div></code></pre><p>and then start the cli installer.</p><p>While you're at it enter</p><pre><code><div class="highlight"><span></span>/sbin/adduser &lt;your_username&gt; sudo
</div></code></pre><p>for later. Then run <code>sync &amp;&amp; init 6</code>.</p><h2>The requirements</h2><p>After updating install the following packages:</p><pre><code><div class="highlight"><span></span>sudo apt-get install build-essential linux-source bc kmod cpio flex libncurses5-dev libelf-dev libssl-dev dwarves rsync
</div></code></pre><h2>Build the kernel</h2><p>Now you can unpack the kernel sources in your home directory:</p><pre><code><div class="highlight"><span></span>tar xavf /usr/src/linux-source-5.10.tar.xz
</div></code></pre><p>Since we don't want to change the kernel-config we can just copy the running config.</p><pre><code><div class="highlight"><span></span><span class="nb">cd</span> linux-source-5.10
cp /boot/config-5.10.0-9-arm64 .config
</div></code></pre><p>Edit the <code>.config</code> file and enter this</p><p><code>CONFIG_SYSTEM_TRUSTED_KEYS = ""</code></p><p>And then run</p><pre><code><div class="highlight"><span></span>make oldconfig
</div></code></pre><p>To build the kernel packages run</p><pre><code><div class="highlight"><span></span>nice make -j<span class="sb">`</span>nproc<span class="sb">`</span> bindeb-pkg
</div></code></pre><h2>Implement the syscall</h2><p>In <code>include/uapi/asm-generic/unistd.h</code></p><pre><code><div class="highlight"><span></span><span class="cp">#define __NR_demo 441</span>
<span class="n">__SYSCALL</span><span class="p">(</span><span class="n">__NR_demo</span><span class="p">,</span><span class="w"> </span><span class="n">sys_demo</span><span class="p">)</span><span class="w"></span>

<span class="cp">#undef __NR_syscalls</span>
<span class="cp">#define __NR_syscalls 442</span>
</div></code></pre><p>In <code>kernel/sys.c</code></p><pre><code><div class="highlight"><span></span><span class="cm">/*</span>
<span class="cm"> * https://brennan.io/2016/11/14/kernel-dev-ep3/</span>
<span class="cm"> */</span><span class="w"> </span>
<span class="n">SYSCALL_DEFINE1</span><span class="p">(</span><span class="n">demo</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="kt">char</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w"></span>
<span class="w">       </span><span class="kt">long</span><span class="w"> </span><span class="n">copied</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strncpy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span><span class="w"></span>
<span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copied</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">copied</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span><span class="w"></span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span><span class="w"></span>
<span class="w">       </span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="w"> </span><span class="s">&quot;demo called with &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</div></code></pre><h2>and the userspace programm</h2><pre><code><div class="highlight"><span></span><span class="cm">/*</span>
<span class="cm"> * https://brennan.io/2016/11/14/kernel-dev-ep3/</span>
<span class="cm"> */</span><span class="w"> </span>
<span class="cp">#define _GNU_SOURCE</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="cp">#define SYS_demo 441</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Must provide a log string</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Making call with &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syscall</span><span class="p">(</span><span class="n">SYS_demo</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;System call returned %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</div></code></pre><h2>Install the kernel</h2><p>If you're using Parallels this would be a good time to take a snapshot, just in case ;)</p><pre><code><div class="highlight"><span></span>sudo dpkg --install linux-image-5.10.70-dbg_5.10.70-1_arm64.deb
sync
sudo init <span class="m">6</span>
</div></code></pre><h2>Test the thing</h2><pre><code><div class="highlight"><span></span>gcc -o demo demo.c
./demo <span class="s2">&quot;but why?&quot;</span>
sudo dmesg
./demo <span class="s2">&quot;For the fun of it ;)&quot;</span>
</div></code></pre><pre><code><div class="highlight"><span></span><span class="p">[</span>   <span class="mf">55.833906</span><span class="p">]</span> <span class="n">demo</span> <span class="n">called</span> <span class="n">with</span> <span class="err">&#39;</span><span class="n">but</span> <span class="n">why</span><span class="p">?</span><span class="err">&#39;</span>
<span class="p">[</span>   <span class="mf">71.208406</span><span class="p">]</span> <span class="n">demo</span> <span class="n">called</span> <span class="n">with</span> <span class="err">&#39;</span><span class="n">For</span> <span class="n">the</span> <span class="n">fun</span> <span class="n">of</span> <span class="n">it</span> <span class="p">;)</span><span class="err">&#39;</span>
</div></code></pre></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>