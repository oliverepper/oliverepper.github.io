<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliver-epper.de/posts/learning-zfs"/><meta name="twitter:url" content="https://oliver-epper.de/posts/learning-zfs"/><meta name="og:url" content="https://oliver-epper.de/posts/learning-zfs"/><title>Learning ZFS | oliep</title><meta name="twitter:title" content="Learning ZFS | oliep"/><meta name="og:title" content="Learning ZFS | oliep"/><meta name="description" content="Learning ZFS on the Mac"/><meta name="twitter:description" content="Learning ZFS on the Mac"/><meta name="og:description" content="Learning ZFS on the Mac"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">Posts</a></li><li><a href="/apps">Apps</a></li><li><a href="https://golf.oliver-epper.de">Golf</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>Learning ZFS</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>13. Februar 2024</li><li><span class="fas fa-clock"></span>5-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/zfs">zfs</a></div></div><p>I've been using TrueNAS Core for a few years now. I am about to switch to a TrueNAS Scale VM on Proxmox. TrueNAS will still have real hardware access to the disk controller and reuse the old disks. To be well prepared I wanted to have some practice with ZFS on my Mac. During that practice, I got hooked. This is what Time Machine tried to be! And it has a much superior UI – one that is scriptable by nature.</p><h2>Installation</h2><p>I installed OpenZFS via brew and allowed the loading of the required kext. You need to change the security policy of your system for this. Boot into recovery mode start <code>Startup Security Utility</code> and change <code>Full Security</code> to <code>Allow user management of kernel extensions from identified developers</code>. After you restart, you can verify that the OpenZFS kext is loaded via the following command: <code>kextstat | grep -v com.apple</code>. This will list all kernel extensions whose names do not begin with 'com.apple'.</p><h2>The Playground</h2><p>I guess you don't have a bunch of high performing disks lying around and even if you had, I'd hope you'd be too lazy to connect them. Let's build four disks from files:</p><pre><code><div class="highlight"><span></span>mkfile<span class="w"> </span>1G<span class="w"> </span>a-disk<span class="w"> </span>b-disk<span class="w"> </span>c-disk<span class="w"> </span>d-disk
</div></code></pre><p>You could use these files immediately as ZFS <code>vdev</code>s, but follow me and attach them via hdiutil to your Mac. It's easier to simulate failing hardware that way. Let's attach the first three for now.</p><pre><code><div class="highlight"><span></span>hdiutil<span class="w"> </span>attach<span class="w"> </span>-imagekey<span class="w"> </span>diskimage-class<span class="o">=</span>CRawDiskImage<span class="w"> </span>-nomount<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/a-disk
hdiutil<span class="w"> </span>attach<span class="w"> </span>-imagekey<span class="w"> </span>diskimage-class<span class="o">=</span>CRawDiskImage<span class="w"> </span>-nomount<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/b-disk
hdiutil<span class="w"> </span>attach<span class="w"> </span>-imagekey<span class="w"> </span>diskimage-class<span class="o">=</span>CRawDiskImage<span class="w"> </span>-nomount<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/c-disk
</div></code></pre><p>On my system that gave me <code>/dev/disk6</code>, <code>/dev/disk7</code>, <code>/dev/disk8</code>.</p><h2>ZFS Pools &amp; File systems</h2><p>Let's build a ZFS pool on <code>disk6</code>:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zpool<span class="w"> </span>create<span class="w"> </span>tank<span class="w"> </span>/dev/disk6
</div></code></pre><p>Now we have a ZFS pool called tank AND a ZFS file system called tank which is the root file system of that pool. Let's create another file system for our experiments:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zfs<span class="w"> </span>create<span class="w"> </span>tank/oliver
</div></code></pre><p>and gives permission to the local user <code>oliver</code>:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>chown<span class="w"> </span>oliver:<span class="w"> </span>/Volumes/tank/oliver
</div></code></pre><p>Now the user <code>oliver</code> can create, modify and delete files and directories in that file system.</p><h2>Snapshots and Sending</h2><p>Let's use <code>disk7</code> and <code>disk8</code> to create a mirror that we use for backups:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zpool<span class="w"> </span>create<span class="w"> </span>backup<span class="w"> </span>mirror<span class="w"> </span>/dev/disk7<span class="w"> </span>/dev/disk8
</div></code></pre><p>Voilà. <code>sudo zpool status</code> should now look like this:</p><pre><code><div class="highlight"><span></span>  <span class="n">pool</span><span class="p">:</span> <span class="n">backup</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">ONLINE</span>
<span class="n">config</span><span class="p">:</span>

    <span class="n">NAME</span>        <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
    <span class="n">backup</span>      <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
      <span class="n">mirror</span><span class="o">-</span><span class="mi">0</span>  <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">disk7</span>   <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">disk8</span>   <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>

<span class="n">errors</span><span class="p">:</span> <span class="n">No</span> <span class="n">known</span> <span class="n">data</span> <span class="n">errors</span>

  <span class="n">pool</span><span class="p">:</span> <span class="n">tank</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">ONLINE</span>
<span class="n">config</span><span class="p">:</span>

    <span class="n">NAME</span>        <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
    <span class="n">tank</span>        <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
      <span class="n">disk6</span>     <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>

<span class="n">errors</span><span class="p">:</span> <span class="n">No</span> <span class="n">known</span> <span class="n">data</span> <span class="n">errors</span>
</div></code></pre><p>Let's touch a file on <code>/Volumes/tank/oliver</code> and then take a snapshot of the file system</p><pre><code><div class="highlight"><span></span>touch<span class="w"> </span>/Volumes/tank/oliver/Init
sudo<span class="w"> </span>zfs<span class="w"> </span>snapshot<span class="w"> </span>tank/oliver@1
</div></code></pre><p>You can list the snapshots with <code>sudo zfs list -t snapshot</code>. It should now look like this:</p><pre><code><div class="highlight"><span></span><span class="n">NAME</span>            <span class="n">USED</span>  <span class="n">AVAIL</span>  <span class="n">REFER</span>  <span class="n">MOUNTPOINT</span>
<span class="n">tank</span><span class="o">/</span><span class="n">oliver</span><span class="p">@</span><span class="mi">1</span>     <span class="mi">0</span><span class="n">B</span>      <span class="o">-</span>  <span class="mf">1.73</span><span class="n">M</span>  <span class="o">-</span>
</div></code></pre><p>Now let's create a backup:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>tank/oliver@1<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>zfs<span class="w"> </span>recv<span class="w"> </span>backup/oliver
</div></code></pre><p>That's it. There is a file system <code>backup/oliver</code> now that contains the file <code>Init</code>.</p><h2>Sending Incremental Snapshots</h2><p>Let's touch another file on <code>tank/oliver</code> and then take another snapshot:</p><pre><code><div class="highlight"><span></span>touch<span class="w"> </span>/Volumes/tank/oliver/One
sudo<span class="w"> </span>zfs<span class="w"> </span>snapshot<span class="w"> </span>tank/oliver@2
</div></code></pre><p>Now let's send only the diff between the first and the second snapshot to the backup pool:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>-RI<span class="w"> </span>@1<span class="w"> </span>tank/oliver@2<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>zfs<span class="w"> </span>recv<span class="w"> </span>-Fu<span class="w"> </span>backup/oliver
</div></code></pre><p>We used different options, here. See me man pages for <code>zfs-send</code> and <code>zfs-recv</code></p><h2>Make the backup safer</h2><p>Let's make our backup even safer:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">copies</span><span class="o">=</span><span class="m">2</span><span class="w"> </span>backup/oliver
</div></code></pre><p>This tells the file system <code>backup/oliver</code> to hold two copies of my precious data. How cool is that?</p><h2>Make the backup smaller</h2><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">compression</span><span class="o">=</span>gzip<span class="w"> </span>backup/oliver
</div></code></pre><h2>Make the backup even more useful</h2><p>Let's delete the files on <code>tank/oliver</code> and safe a new snapshot to the backup:</p><pre><code><div class="highlight"><span></span>rm<span class="w"> </span>/Volumes/tank/oliver/*
sudo<span class="w"> </span>zfs<span class="w"> </span>snapshot<span class="w"> </span>tank/oliver@3
sudo<span class="w"> </span>zfs<span class="w"> </span>send<span class="w"> </span>-RI<span class="w"> </span>@2<span class="w"> </span>tank/oliver@3<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>zfs<span class="w"> </span>recv<span class="w"> </span>-Fu<span class="w"> </span>backup/oliver
</div></code></pre><p>Let's make all of our snapshots visible to the file system <code>backup/oliver</code>:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zfs<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="nv">snapdir</span><span class="o">=</span>visible<span class="w"> </span>backup/oliver
</div></code></pre><p>Now open <code>/Volumes/backup/oliver</code> in Finder and press <code>Cmd</code> + <code>Shift</code> + <code>.</code> to make dot-files visible and navigate to <code>.zfs/snapshot/oliver@2</code> and you have read-only access to your deleted files.</p><figure>
    <picture>
        <source srcset="/images/zfs-snapshots-dark.png" media="(prefers-color-scheme: dark)">
        <img src="/images/zfs-snapshots.png" alt="zfs-snapshots">
    </picture>
</figure><h2>Simulate a disk-failure</h2><p>Let's export (think unmount) the pool <code>backup</code>:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zpool<span class="w"> </span><span class="nb">export</span><span class="w"> </span>backup
</div></code></pre><p>and detach <code>disk8</code>:</p><pre><code><div class="highlight"><span></span>hdiutil<span class="w"> </span>detach<span class="w"> </span>/dev/disk8
</div></code></pre><p>Now bring back the pool <code>backup</code>, again:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zpool<span class="w"> </span>import<span class="w"> </span>backup
</div></code></pre><p><code>sudo zpool status -x</code> should now look like this:</p><pre><code><div class="highlight"><span></span>  <span class="n">pool</span><span class="p">:</span> <span class="n">backup</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">DEGRADED</span>
<span class="n">status</span><span class="p">:</span> <span class="n">One</span> <span class="n">or</span> <span class="n">more</span> <span class="n">devices</span> <span class="n">could</span> <span class="n">not</span> <span class="n">be</span> <span class="n">opened</span><span class="p">.</span>  <span class="n">Sufficient</span> <span class="n">replicas</span> <span class="n">exist</span> <span class="k">for</span>
    <span class="n">the</span> <span class="n">pool</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">functioning</span> <span class="k">in</span> <span class="n">a</span> <span class="n">degraded</span> <span class="n">state</span><span class="p">.</span>
<span class="n">action</span><span class="p">:</span> <span class="n">Attach</span> <span class="n">the</span> <span class="n">missing</span> <span class="n">device</span> <span class="n">and</span> <span class="n">online</span> <span class="n">it</span> <span class="n">using</span> <span class="err">&#39;</span><span class="n">zpool</span> <span class="n">online</span><span class="err">&#39;</span><span class="p">.</span>
   <span class="n">see</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="c1">//openzfs.github.io/openzfs-docs/msg/ZFS-8000-2Q</span>
<span class="n">config</span><span class="p">:</span>

    <span class="n">NAME</span>                                            <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
    <span class="n">backup</span>                                          <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
      <span class="n">mirror</span><span class="o">-</span><span class="mi">0</span>                                      <span class="n">DEGRADED</span>     <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">media</span><span class="o">-</span><span class="mi">0</span><span class="n">BC56ABF</span><span class="o">-</span><span class="mi">50</span><span class="n">C7</span><span class="o">-</span><span class="n">AF4C</span><span class="o">-</span><span class="n">BC93</span><span class="o">-</span><span class="mi">86</span><span class="n">D958969282</span>  <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="mi">1904242345373318257</span>                         <span class="n">UNAVAIL</span>      <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>  <span class="n">was</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk8s1</span>

<span class="n">errors</span><span class="p">:</span> <span class="n">No</span> <span class="n">known</span> <span class="n">data</span> <span class="n">errors</span>
</div></code></pre><p>Attach the file <code>d-disk</code>:</p><pre><code><div class="highlight"><span></span>hdiutil<span class="w"> </span>attach<span class="w"> </span>-imagekey<span class="w"> </span>diskimage-class<span class="o">=</span>CRawDiskImage<span class="w"> </span>-nomount<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/d-disk
</div></code></pre><p>This became <code>/dev/disk10</code> on my system. Let's use it to replace the unavailable <code>vdev</code> in <code>backup</code>:</p><pre><code><div class="highlight"><span></span>sudo<span class="w"> </span>zpool<span class="w"> </span>replace<span class="w"> </span>backup<span class="w"> </span><span class="m">1904242345373318257</span><span class="w"> </span>/dev/disk10
</div></code></pre><p>Done. <code>sudo zpool status -x</code> shows <code>all pools are healthy</code>.</p><pre><code><div class="highlight"><span></span>  <span class="n">pool</span><span class="p">:</span> <span class="n">backup</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">ONLINE</span>
  <span class="n">scan</span><span class="p">:</span> <span class="n">resilvered</span> <span class="mf">4.59</span><span class="n">M</span> <span class="k">in</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="n">with</span> <span class="mi">0</span> <span class="n">errors</span> <span class="n">on</span> <span class="n">Tue</span> <span class="n">Feb</span> <span class="mi">13</span> <span class="mi">15</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">51</span> <span class="mi">2024</span>
<span class="n">config</span><span class="p">:</span>

    <span class="n">NAME</span>                                            <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
    <span class="n">backup</span>                                          <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
      <span class="n">mirror</span><span class="o">-</span><span class="mi">0</span>                                      <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">media</span><span class="o">-</span><span class="mi">0</span><span class="n">BC56ABF</span><span class="o">-</span><span class="mi">50</span><span class="n">C7</span><span class="o">-</span><span class="n">AF4C</span><span class="o">-</span><span class="n">BC93</span><span class="o">-</span><span class="mi">86</span><span class="n">D958969282</span>  <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
        <span class="n">disk10</span>                                      <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>

<span class="n">errors</span><span class="p">:</span> <span class="n">No</span> <span class="n">known</span> <span class="n">data</span> <span class="n">errors</span>

  <span class="n">pool</span><span class="p">:</span> <span class="n">tank</span>
 <span class="n">state</span><span class="p">:</span> <span class="n">ONLINE</span>
<span class="n">config</span><span class="p">:</span>

    <span class="n">NAME</span>        <span class="n">STATE</span>     <span class="n">READ</span> <span class="n">WRITE</span> <span class="n">CKSUM</span>
    <span class="n">tank</span>        <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>
      <span class="n">disk6</span>     <span class="n">ONLINE</span>       <span class="mi">0</span>     <span class="mi">0</span>     <span class="mi">0</span>

<span class="n">errors</span><span class="p">:</span> <span class="n">No</span> <span class="n">known</span> <span class="n">data</span> <span class="n">errors</span>
</div></code></pre><p><code>disk10</code> will become something like <code>media-xxxx</code> when you export and import the pool <code>backup</code>.</p><h2>Addendum</h2><p>Just for reference. If you want to see the mapping between gptids and classic device names on FreeBSD use <code>glabel status</code>. In macOS this is shown by <code>diskutil list</code> or <code>diskutil info</code>. <code>diskutil info /dev/disk7s1</code> shows <code>0BC56ABF-50C7-AF4C-BC93-86D958969282</code> which matches the media-id of the first disk in the pool <code>backup</code>.</p></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>