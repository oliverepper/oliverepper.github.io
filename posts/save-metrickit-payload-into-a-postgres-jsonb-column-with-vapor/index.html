<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliver-epper.de/posts/save-metrickit-payload-into-a-postgres-jsonb-column-with-vapor"/><meta name="twitter:url" content="https://oliver-epper.de/posts/save-metrickit-payload-into-a-postgres-jsonb-column-with-vapor"/><meta name="og:url" content="https://oliver-epper.de/posts/save-metrickit-payload-into-a-postgres-jsonb-column-with-vapor"/><title>MetricKit and Vapor | oliep</title><meta name="twitter:title" content="MetricKit and Vapor | oliep"/><meta name="og:title" content="MetricKit and Vapor | oliep"/><meta name="description" content="Save MetricKit payload into a postgres jsonb column with vapor"/><meta name="twitter:description" content="Save MetricKit payload into a postgres jsonb column with vapor"/><meta name="og:description" content="Save MetricKit payload into a postgres jsonb column with vapor"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">My posts</a></li><li><a href="https://golf.oliver-epper.de">Golf</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>MetricKit and Vapor</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>9. Juli 2020</li><li><span class="fas fa-clock"></span>3-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/swift">Swift</a>&middot;<a href="/tags/server">Server</a>&middot;<a href="/tags/vapor">Vapor</a>&middot;<a href="/tags/fluent">Fluent</a></div></div><p>I recently learned about MetricKit from Apple and I thought this would be a good fit to learn something about my iOS code in the wild.</p><p>Using MetricKit could not be easier. After you conformed to <code>MXMetricManagerSubscriber</code> you can add yourself to the <code>MXMetricManager</code></p><pre><code><div class="highlight"><span></span><span class="bp">MXMetricManager</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
</div></code></pre><p>The most obvious place would be the AppDelegate's <code>didFinishLaunchingWithOptions</code> function. You can use <code>applicationWillTerminate</code> to remove yourself from the MXMetricManager</p><pre><code><div class="highlight"><span></span><span class="bp">MXMetricManager</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
</div></code></pre><p>The only thing that's left is implementing the delegate method:</p><pre><code><div class="highlight"><span></span><span class="kd">extension</span> <span class="nc">AppDelegate</span><span class="p">:</span> <span class="bp">MXMetricManagerSubscriber</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">didReceive</span><span class="p">(</span><span class="kc">_</span> <span class="n">payloads</span><span class="p">:</span> <span class="p">[</span><span class="bp">MXMetricPayload</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">payload</span> <span class="k">in</span> <span class="n">payloads</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">url</span> <span class="p">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="s">&quot;https://your.vapor.server/collect&quot;</span><span class="p">)</span><span class="o">!</span>

            <span class="kd">var</span> <span class="nv">request</span> <span class="p">=</span> <span class="n">URLRequest</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">request</span><span class="p">.</span><span class="n">httpMethod</span> <span class="p">=</span> <span class="s">&quot;POST&quot;</span>
            <span class="n">request</span><span class="p">.</span><span class="n">httpBody</span> <span class="p">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">jsonRepresentation</span><span class="p">()</span>

            <span class="kd">let</span> <span class="nv">task</span> <span class="p">=</span> <span class="n">URLSession</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">dataTask</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="n">task</span><span class="p">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>All this and more is nicely documented on <a href="https://nshipster.com/metrickit/">NSHipster â€“ MetricKit</a>.</p><h2>Vapor</h2><p>So in Vapor we need a <code>/collect</code>-route that takes the payload. The easiest solution would be to build a struct that takes some (or all) of the information from the payload, but I wanted to do the same thing Matt did (in Ruby or JS) and just save the payload in a jsonb-column.</p><p>With the help of the really great people in the Vapor-Discord (namely: TypeBeta) I was able to achieve what I wanted with the following model-class</p><pre><code><div class="highlight"><span></span><span class="kd">import</span> <span class="nc">Vapor</span>
<span class="kd">import</span> <span class="nc">Fluent</span>
<span class="kd">import</span> <span class="nc">PostgresNIO</span>

<span class="kd">struct</span> <span class="nc">JsonWrapper</span><span class="p">:</span> <span class="n">Codable</span><span class="p">,</span> <span class="n">PostgresDataConvertible</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">payload</span><span class="p">:</span> <span class="nb">String</span>

    <span class="kd">static</span> <span class="kd">var</span> <span class="nv">postgresDataType</span><span class="p">:</span> <span class="n">PostgresDataType</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">jsonb</span>
    <span class="p">}</span>

    <span class="kd">init</span><span class="p">(</span><span class="kc">_</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">payload</span> <span class="p">=</span> <span class="n">payload</span>
    <span class="p">}</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">from</span> <span class="n">decoder</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">payload</span> <span class="p">=</span> <span class="k">try</span> <span class="nb">String</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">decoder</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">to</span> <span class="n">encoder</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">payload</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">encoder</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">init</span><span class="p">?(</span><span class="n">postgresData</span><span class="p">:</span> <span class="n">PostgresData</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">postgresData</span><span class="p">.</span><span class="n">jsonb</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">payload</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">var</span> <span class="nv">postgresData</span><span class="p">:</span> <span class="n">PostgresData</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">jsonString</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">return</span> <span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">jsonb</span><span class="p">:</span> <span class="n">jsonString</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kr">final</span> <span class="kd">class</span> <span class="nc">Metric</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Content</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">let</span> <span class="nv">schema</span> <span class="p">=</span> <span class="s">&quot;metrics&quot;</span>

    <span class="p">@</span><span class="n">ID</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="p">.</span><span class="n">id</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span>
    
    <span class="p">@</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="s">&quot;payload&quot;</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nv">payload</span><span class="p">:</span> <span class="n">JsonWrapper</span>

    <span class="kd">init</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">UUID</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="n">JsonWrapper</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">id</span> <span class="p">=</span> <span class="n">id</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">payload</span> <span class="p">=</span> <span class="n">payload</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>In the <code>Metric</code>-class the member payload is of type <code>JsonWrapper</code>. This type tells postgres how to get the wrapped payload into postgres (<code>var postgresData</code>) and how to initialise the payload from the data that is saved in postgres (<code>init?(postgresData: PostgresData)</code>). The PostgresData-initializer (<code>.init(jsonb: jsonString)</code>) tells the type that it should treat <code>jsonString</code> as json.</p><p>Now the controller becomes a piece of cake ðŸ˜Ž</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">MetricController</span><span class="p">:</span> <span class="n">RouteCollection</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">boot</span><span class="p">(</span><span class="n">routes</span><span class="p">:</span> <span class="n">RoutesBuilder</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">collect</span> <span class="p">=</span> <span class="n">routes</span><span class="p">.</span><span class="n">grouped</span><span class="p">(</span><span class="s">&quot;collect&quot;</span><span class="p">)</span>
        <span class="n">collect</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">use</span><span class="p">:</span> <span class="n">create</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="n">HTTPStatus</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">metric</span> <span class="p">=</span> <span class="n">Metric</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nv">payload_string</span> <span class="p">=</span> <span class="k">try</span> <span class="n">req</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
        <span class="n">metric</span><span class="p">.</span><span class="n">payload</span> <span class="p">=</span> <span class="n">JsonWrapper</span><span class="p">(</span><span class="n">payload_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metric</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">on</span><span class="p">:</span> <span class="n">req</span><span class="p">.</span><span class="n">db</span><span class="p">).</span><span class="n">transform</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">HTTPStatus</span><span class="p">.</span><span class="n">noContent</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><h2>Heads up</h2><p>Simulating MetricKit payload is only enabled on a real device. So you need to run your iOS code on a real device. Once you have data in the database you can query "into" your payload like this:</p><pre><code><div class="highlight"><span></span><span class="k">select</span> <span class="n">payload</span><span class="o">-&gt;</span><span class="s1">&#39;appVersion&#39;</span> <span class="k">from</span> <span class="n">metrics</span><span class="p">;</span>
</div></code></pre><p>Or how about building a view:</p><pre><code><div class="highlight"><span></span><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">app_versions</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span><span class="n">payload</span><span class="o">-&gt;</span><span class="s1">&#39;appVersion&#39;</span> <span class="k">AS</span> <span class="n">app_version</span><span class="p">,</span><span class="n">payload</span><span class="o">-&gt;</span><span class="s1">&#39;metaData&#39;</span><span class="o">-&gt;&gt;</span><span class="s1">&#39;deviceType&#39;</span> <span class="k">AS</span> <span class="n">device_type</span> <span class="k">FROM</span> <span class="n">metrics</span><span class="p">;</span>
</div></code></pre><p>Now you can do something like this:</p><pre><code><div class="highlight"><span></span><span class="k">select</span> <span class="k">distinct</span><span class="p">(</span><span class="n">app_version</span><span class="p">)</span> <span class="k">from</span> <span class="n">app_versions</span><span class="p">;</span>
</div></code></pre><h2>Question</h2><p>This is completely unrelated, but: Is it a good idea to have UUID as primary keys? Does this have any performance implications?</p></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>