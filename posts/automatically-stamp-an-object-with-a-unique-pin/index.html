<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliver-epper.de/posts/automatically-stamp-an-object-with-a-unique-pin"/><meta name="twitter:url" content="https://oliver-epper.de/posts/automatically-stamp-an-object-with-a-unique-pin"/><meta name="og:url" content="https://oliver-epper.de/posts/automatically-stamp-an-object-with-a-unique-pin"/><title>Automatically stamp an object with a unique pin | oliep</title><meta name="twitter:title" content="Automatically stamp an object with a unique pin | oliep"/><meta name="og:title" content="Automatically stamp an object with a unique pin | oliep"/><meta name="description" content="Stamp an object with an unique pin before saving into the database"/><meta name="twitter:description" content="Stamp an object with an unique pin before saving into the database"/><meta name="og:description" content="Stamp an object with an unique pin before saving into the database"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">Posts</a></li><li><a href="/apps">Apps</a></li><li><a href="https://golf.oliver-epper.de">Golf</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>Automatically stamp an object with a unique pin</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>17. Juni 2020</li><li><span class="fas fa-clock"></span>5-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/swift">Swift</a>&middot;<a href="/tags/server">Server</a>&middot;<a href="/tags/vapor">Vapor</a>&middot;<a href="/tags/fluent">Fluent</a></div></div><p>I recently started using Vapor and I love it! Using Swift on the server is sweet and Vapor has a really nice API. I wanted to do a "simple" thing that turned out to be harder than I initially thought it would be but Swift and Vapor made it actually fun to strive for a nice solution.</p><h2>What I wanted to do</h2><p>Imagine that you want to store something away but first put a little sticker on it. You have a box full of things to store, a sheet of stickers and the cabinet where you want to put the things. So:</p><pre><code><div class="highlight"><span></span><span class="n">take_a_thing</span>
<span class="n">take_a_sticker</span>
<span class="n">put_sticker_on_thing</span>
<span class="n">put_thing_in_cabinet</span>
</div></code></pre><p>Easy, isn't it?</p><p>The <code>take_a_sticker</code> part can be tricky. What if you have someone that helps you and you both grab the same sticker? Clearly you want to SELECT and DELETE the sticker (from a database) in an atomic operation.</p><h2>How to implement the ModelMiddleware?</h2><p>With Vapor you can register a <code>ModelMiddleware</code> that you can use to provide lifecycle functions for your model. Let's say you want to hook into the create process:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">ThingMiddleware</span><span class="p">:</span> <span class="n">ModelMiddleware</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Thing</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;This will happen before the create&quot;</span><span class="p">)</span>
        <span class="n">next</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">).</span><span class="bp">map</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;This will happen after the create&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>Isn't it cool how Swift infers the type for the ThingMiddleware through the create functions model parameter? It doesn't require you to write:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">ThingMiddleware</span><span class="p">:</span> <span class="n">ModelMiddleware</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="n">model</span> <span class="p">=</span> <span class="n">Thing</span>

    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>So we're handling with Futures here.</p><p>Let's try to express the pseudocode from above. What about this:</p><pre><code><div class="highlight"><span></span><span class="c1">// ATTENTION: THIS DOES NOT WORK!</span>
<span class="kd">struct</span> <span class="nc">PinErrror</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span> <span class="p">}</span>

<span class="kd">struct</span> <span class="nc">ClientConfigMiddleware</span><span class="p">:</span> <span class="n">ModelMiddleware</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">ClientConfig</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">getPin</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">db</span><span class="p">).</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">pin</span> <span class="k">in</span>
            <span class="n">model</span><span class="p">.</span><span class="n">pin</span> <span class="p">=</span> <span class="n">pin</span>
            <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">getPin</span><span class="p">(</span><span class="n">from</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">sql</span> <span class="p">=</span> <span class="n">db</span> <span class="k">as</span><span class="p">?</span> <span class="n">SQLDatabase</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">fatalError</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&quot;SELECT * FROM pins LIMIT 1&quot;</span><span class="p">).</span><span class="bp">first</span><span class="p">().</span><span class="n">flatMapThrowing</span> <span class="p">{</span> <span class="n">row</span> <span class="k">in</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">pin</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">row</span><span class="p">?.</span><span class="n">decode</span><span class="p">(</span><span class="n">column</span><span class="p">:</span> <span class="s">&quot;pin&quot;</span><span class="p">,</span> <span class="k">as</span><span class="p">:</span> <span class="nb">Int</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span>
                <span class="kc">_</span> <span class="p">=</span> <span class="n">sql</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&quot;DELETE FROM pins WHERE pin=&#39;</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">pin</span><span class="si">))</span><span class="s">&#39;&quot;</span><span class="p">).</span><span class="n">run</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">pin</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="n">PinErrror</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>The logic basically says:</p><pre><code><div class="highlight"><span></span><span class="n">create</span><span class="p">:</span>
	<span class="k">return</span> <span class="n">getNextSticker</span><span class="p">.</span><span class="n">if_ok</span>
		<span class="n">put_sticker_on_model</span>
		<span class="n">save_model</span>

<span class="n">getNextSticker</span><span class="p">:</span>
	<span class="k">return</span> <span class="kr">get</span> <span class="n">sticker_from_db</span><span class="p">.</span><span class="n">if_ok</span>
		<span class="n">delete_sticker_from_db</span><span class="p">.</span><span class="n">if_ok</span>
			<span class="k">return</span> <span class="n">sticker</span>
</div></code></pre><p>That should do it, right?</p><p>Well not quite. With a blocking database driver I guess that would work but what happens in Vapor is that if you create a bunch of model objects they all get the same sticker!</p><p>We need something a bit more clever. After doing a bit of research and asking around the people in the Vapor Discord Tanner the inventor of Vapor pointed me to a post on Stackoverflow that had a great idea for situation that was quite similar:</p><h2>Why not call dibs on the row, first?</h2><p>What if the code wouldn't just select (and then delete) the first entry, but mark it with something if it is not marked, yet. For example the current thread-id, a timestamp, or a uuid? Then the code can select that very entry while everyone else can continue with their own marked entries.</p><p>So here's how you can make it work in code:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">PinError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span> <span class="p">}</span>

<span class="kd">struct</span> <span class="nc">ClientConfigMiddleware</span><span class="p">:</span> <span class="n">ModelMiddleware</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">create</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">ClientConfig</span><span class="p">,</span> <span class="n">on</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">,</span> <span class="n">next</span><span class="p">:</span> <span class="n">AnyModelResponder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">getNextPin</span><span class="p">(</span><span class="n">from</span><span class="p">:</span> <span class="n">db</span><span class="p">).</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">pin</span> <span class="k">in</span>
            <span class="n">model</span><span class="p">.</span><span class="n">pin</span> <span class="p">=</span> <span class="n">pin</span>
            <span class="k">return</span> <span class="n">next</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">on</span><span class="p">:</span> <span class="n">db</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">getNextPin</span><span class="p">(</span><span class="n">from</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">sql</span> <span class="p">=</span> <span class="n">db</span> <span class="k">as</span><span class="p">?</span> <span class="n">SQLDatabase</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">fatalError</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">selector</span> <span class="p">=</span> <span class="n">UUID</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&quot;UPDATE pins SET selector=&#39;</span><span class="si">\(</span><span class="n">selector</span><span class="p">.</span><span class="n">uuidString</span><span class="si">)</span><span class="s">&#39; WHERE pin = (SELECT pin FROM pins WHERE selector IS NULL LIMIT 1)&quot;</span><span class="p">).</span><span class="n">run</span><span class="p">().</span><span class="n">flatMap</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">sql</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&quot;SELECT pin FROM pins WHERE selector=&#39;</span><span class="si">\(</span><span class="n">selector</span><span class="p">.</span><span class="n">uuidString</span><span class="si">)</span><span class="s">&#39;&quot;</span><span class="p">).</span><span class="bp">first</span><span class="p">().</span><span class="n">flatMapThrowing</span> <span class="p">{</span> <span class="n">row</span> <span class="k">in</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">pin</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">row</span><span class="p">?.</span><span class="n">decode</span><span class="p">(</span><span class="n">column</span><span class="p">:</span> <span class="s">&quot;pin&quot;</span><span class="p">,</span> <span class="k">as</span><span class="p">:</span> <span class="nb">Int</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">pin</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="n">PinError</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</div></code></pre><p>So now we have:</p><pre><code><div class="highlight"><span></span><span class="n">create</span><span class="p">:</span>
	<span class="k">return</span> <span class="n">getNextSticker</span><span class="p">.</span><span class="n">if_ok</span>
		<span class="n">put_sticker_on_model</span>
		<span class="n">save_model</span>

<span class="n">getNextSticker</span><span class="p">:</span>
	<span class="k">return</span> <span class="kr">get</span> <span class="n">mark_a_sticker_that_is_not_yet_marked_with_myId</span><span class="p">.</span><span class="n">if_ok</span>
		<span class="k">return</span> <span class="n">select_the_sticker_that_is_marked_with_myId</span><span class="p">.</span><span class="n">if_ok</span>
			<span class="k">return</span> <span class="n">sticker</span>
</div></code></pre><p>The pins table is a prepopulated table that has two columns. One for the actual pin and one called selector that is prepopulated with NULL. The <code>getNextPin</code> function writes a uuid that it saves in the selector column and can then read a pin by selecting the row with the matching selector. Pretty neat, isn't it</p><h2>Update</h2><p>When I test this under heavy load (&gt; 100 creations/s) I still keep getting the same pins sometimes. While this is not a problem for my use case I am still very interested in an even better solution. When I use <code>Date().timeIntervalSince1970</code> I get the same pins less frequently but I guess that's just because the operation might be slower than getting an UUID. Any ideas welcome!</p><h2>Update 2</h2><p>Here's the fix üòé With Postgres you can tell the database to skip an entry if it cannot attain a lock immediatley! That solves it:</p><pre><code><div class="highlight"><span></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">pins</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">selector</span><span class="o">=</span><span class="n">uuid_string</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">pins</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">SKIP</span><span class="w"> </span><span class="n">LOCKED</span><span class="p">)</span><span class="w"> </span><span class="n">RETURNING</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
</div></code></pre><p>In code:</p><pre><code><div class="highlight"><span></span><span class="kd">private</span> <span class="kd">func</span> <span class="nf">getNextPin</span><span class="p">(</span><span class="n">from</span> <span class="n">db</span><span class="p">:</span> <span class="n">Database</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">EventLoopFuture</span><span class="p">&lt;</span><span class="nb">Int</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">sql</span> <span class="p">=</span> <span class="n">db</span> <span class="k">as</span><span class="p">?</span> <span class="n">SQLDatabase</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">fatalError</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="kd">let</span> <span class="nv">selector</span> <span class="p">=</span> <span class="n">UUID</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">sql</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&quot;UPDATE pins SET selector=&#39;</span><span class="si">\(</span><span class="n">selector</span><span class="p">.</span><span class="n">uuidString</span><span class="si">)</span><span class="s">&#39; WHERE pin = (SELECT pin FROM pins WHERE selector IS NULL LIMIT 1 FOR UPDATE SKIP LOCKED) RETURNING pin&quot;</span><span class="p">).</span><span class="n">run</span><span class="p">().</span><span class="n">flatMap</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">sql</span><span class="p">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&quot;SELECT pin FROM pins WHERE selector=&#39;</span><span class="si">\(</span><span class="n">selector</span><span class="p">.</span><span class="n">uuidString</span><span class="si">)</span><span class="s">&#39;&quot;</span><span class="p">).</span><span class="bp">first</span><span class="p">().</span><span class="n">flatMapThrowing</span> <span class="p">{</span> <span class="n">row</span> <span class="k">in</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">pin</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">row</span><span class="p">?.</span><span class="n">decode</span><span class="p">(</span><span class="n">column</span><span class="p">:</span> <span class="s">&quot;pin&quot;</span><span class="p">,</span> <span class="k">as</span><span class="p">:</span> <span class="nb">Int</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="n">pin</span>
                <span class="p">}</span>
                <span class="k">throw</span> <span class="n">PinError</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</div></code></pre><p>Oh! And as an added bonus object creation under heavy load get's around 30% quicker. ‚ö°Ô∏è</p></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>