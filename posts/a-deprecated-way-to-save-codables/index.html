<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="og:site_name" content="oliep"/><link rel="canonical" href="https://oliver-epper.de/posts/a-deprecated-way-to-save-codables"/><meta name="twitter:url" content="https://oliver-epper.de/posts/a-deprecated-way-to-save-codables"/><meta name="og:url" content="https://oliver-epper.de/posts/a-deprecated-way-to-save-codables"/><title>A deprecated way to save Codables – but why? | oliep</title><meta name="twitter:title" content="A deprecated way to save Codables – but why? | oliep"/><meta name="og:title" content="A deprecated way to save Codables – but why? | oliep"/><meta name="description" content="Saving one Codable a time directly to a file handle."/><meta name="twitter:description" content="Saving one Codable a time directly to a file handle."/><meta name="og:description" content="Saving one Codable a time directly to a file handle."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to oliep"/></head><body><div class="wrapper"><header><div class="container"><nav class="navigation"><a href="/">oliep</a><ul><li><a href="/posts">My posts</a></li><li><a href="https://golf.oliver-epper.de">Golf</a></li><li><a href="/bikerr">Bikerr</a></li><li><a href="/about">About</a></li></ul></nav></div></header><main class="grow"><div class="container"><article><h1>A deprecated way to save Codables – but why?</h1><div class="item-metadata"><ul><li><span class="fas fa-calendar"></span>21. Februar 2020</li><li><span class="fas fa-clock"></span>2-minute read</li></ul><div class="taglist"><span class="fas fa-tags"></span><a href="/tags/swift">Swift</a>&middot;<a href="/tags/ios">iOS</a>&middot;<a href="/tags/codables">Codables</a></div></div><p>I was looking for a way to save a lot of Codables that emerge over a potentially long timespan. Just keeping them in memory looked like the obvious thing to do but I wanted something failsafe and persistent.</p><p>Saving a Codable to a file in Swift couldn’t be easier: <code>JSONEncoder.encode(T)</code> returns <code>Data</code>. That can be written to an <code>URL</code> via <code>write(to: URL)</code>.</p><p>But what if I want to append?</p><p>I for sure don’t want to load the data from a file, decode it into a JSON array, append the new Codable to the array, encode the array to data and then use that data to overwrite the file.</p><p>I do the following:</p><p>An instance of <code>CodableFileBuffer&lt;T&gt;</code> keeps an open FileHandle on an URL and whenever I call <code>append(codable)</code> on that buffer it encodes to data and writes that data to the file handle.</p><pre><code><div class="highlight"><span></span><span class="kd">public</span> <span class="kd">func</span> <span class="nf">append</span><span class="p">(</span><span class="kc">_</span> <span class="n">codable</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// encode codable</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">encoder</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">codable</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
        <span class="bp">fatalError</span><span class="p">(</span><span class="s">&quot;Cannot encode </span><span class="si">\(</span><span class="n">codable</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// write to FileHandle</span>
    <span class="n">fileHandle</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">fileHandle</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span><span class="p">)</span>

    <span class="c1">// log</span>
    <span class="n">os_log</span><span class="p">(</span><span class="s">&quot;Did append codable to CodableFileBuffer at: %@&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span> <span class="n">OSLog</span><span class="p">.</span><span class="n">CodableFileBuffer</span><span class="p">,</span> <span class="n">type</span><span class="p">:</span> <span class="p">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">fileURL</span><span class="p">.</span><span class="n">lastPathComponent</span><span class="p">)</span>
<span class="p">}</span>
</div></code></pre><p>This could use a little more error handling but it is just for demo purpose. Bare with me.</p><p>The only thing not completely obvious happens on line 9. This ist just the comma that is required to form a JSON array. When I create the FileHandle I immediately write an opening square bracket to the file and the <code>retrieve() -&gt; [Codable]</code> function appends the closing square-bracket to the data before it passes it to the JSONDecoder.</p><p>So the files content loos like this:</p><pre><code><div class="highlight"><span></span><span class="c1">// after initializing</span>
<span class="p">[</span>

<span class="c1">// after writing the first codable</span>
<span class="p">[{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="s">&quot;value_one&quot;</span><span class="p">},</span>

<span class="c1">// after writing the second codable</span>
<span class="p">[{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="s">&quot;value_one&quot;</span><span class="p">},{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="s">&quot;another_value&quot;</span><span class="p">},</span>

<span class="c1">// the data that gets passed to the JSONDecoder looks like this</span>
<span class="p">[{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="s">&quot;value_one&quot;</span><span class="p">},{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="s">&quot;another_value&quot;</span><span class="p">},]</span>
</div></code></pre><p>I know the trailing comma is ugly and no valid json. It would be an easy fix but actually the <code>JSONDecoder</code> is pretty forgiving, here.</p><p>So what do we have now?</p><p>We have a Buffer that can be used like this:</p><pre><code><div class="highlight"><span></span><span class="kd">struct</span> <span class="nc">MyCodable</span><span class="p">:</span> <span class="n">Codable</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">id</span><span class="p">:</span> <span class="nb">Int</span>
    <span class="kd">var</span> <span class="nv">key</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nv">buffer</span> <span class="p">=</span> <span class="n">CodableFileBuffer</span><span class="p">&lt;</span><span class="n">MyCodable</span><span class="p">&gt;()</span>

<span class="n">buffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyCodable</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="s">&quot;value_one&quot;</span><span class="p">))</span>
<span class="n">buffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyCodable</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="s">&quot;another_value&quot;</span><span class="p">))</span>

<span class="kd">let</span> <span class="nv">myCodables</span> <span class="p">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">retrieve</span><span class="p">()</span>
</div></code></pre><p>Neat, isn’t it?</p><p>I use it to append thousands of Codables and it works pretty nice, so far. I measured it with instruments using tens of thousands to Codables. And I use it on real devices running for days.</p><p>Here’s the complete thing:</p><p><a href="https://github.com/oliverepper/CodableFileBuffer">CodeableFileBuffer</a></p><p>So what’s next?</p><p>I have a few questions I’d like to discuss:</p><ol><li>Why is <code>FileHandle.write</code> deprecated? It sure doesn’t look swifty. It can throw exceptions without beeing marked as throwing.</li><li>How are we supposed to replace this? How does the <code>writeabilityHandler</code> work? Can anyone provide an example?</li><li>What do you think? I guess there must be other or better ways to buffer Codables on disk.</li></ol><p>I’d really appreciate your ideas.</p></article></div></main><footer><div class="container"><div class="credits">Oliver Epper &middot; made with <a href="https://github.com/johnsundell/publish" target="_blank">Publish</a> &middot;  inspired by <a href="https://github.com/luizdepra/hugo-coder" target="_blank">Coder</a> &middot; <a href="/feed.rss">RSS feed</a></div></div></footer></div><script src="https://kit.fontawesome.com/fd7cbf6928.js" crossorigin="anonmous"></script></body></html>